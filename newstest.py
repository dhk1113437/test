# -*- coding: utf-8 -*-
"""newstest.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1u9gbUgry0Ncy0APDWv2psOUVegZnXg6X
"""

import requests
import datetime
import re

# ===== [ì„¤ì •] =====
REGIONS = ["ì¶©ì²­", "ì¶©ë‚¨", "ì¶©ë¶", "ëŒ€ì „", "ì„¸ì¢…", "ê°•ì›"]
FAULTS = ["ì‚¬ì „íˆ¬í‘œ"]
TOKEN = "7850330463:AAFQ7gjUc4tNp1Tv68YDUDc-e6oS5fDUf4c"
CHAT_ID = "-4784405371"

NAVER_CLIENT_ID = "E8O90EX19G9rVFg6SyFY"
NAVER_CLIENT_SECRET = "ChywCbWRGX"

# ===== [1] ë„¤ì´ë²„ ë‰´ìŠ¤ API í•¨ìˆ˜ =====
def crawl_naver_news(keywords):
    print("ğŸŸ¢ [NAVER] ë‰´ìŠ¤ APIë¡œ ìˆ˜ì§‘ ì¤‘...")
    results = []
    url = "https://openapi.naver.com/v1/search/news.json"
    headers = {
        "X-Naver-Client-Id": NAVER_CLIENT_ID,
        "X-Naver-Client-Secret": NAVER_CLIENT_SECRET
    }
    for keyword in keywords:
        params = {
            "query": keyword,
            "display": 10,
            "sort": "date"
        }
        res = requests.get(url, headers=headers, params=params)
        if res.status_code == 200:
            items = res.json().get("items", [])
            for item in items:
                title = re.sub('<.*?>', '', item.get("title", ""))
                desc = re.sub('<.*?>', '', item.get("description", ""))
                link = item.get("link", "")
                results.append({
                    "title": title,
                    "desc": desc,
                    "link": link
                })
        else:
            print(f"âŒ ë„¤ì´ë²„ API í˜¸ì¶œ ì‹¤íŒ¨: {res.status_code} ({keyword})")
    return results

# ===== [2] AND ì¡°ê±´ í•„í„°ë§ í•¨ìˆ˜ =====
def filter_news_and(news, regions, faults):
    filtered = []
    for n in news:
        content = n["title"] + " " + n["desc"]
        for region in regions:
            for fault in faults:
                if region in content and fault in content:
                    filtered.append(f"[{region}+{fault}] {n['title']}\n{n['link']}")
    return list(set(filtered))  # ì¤‘ë³µ ì œê±°

# ===== [3] í…”ë ˆê·¸ë¨ ì „ì†¡ í•¨ìˆ˜ =====
def send_telegram_message(message: str, token: str, chat_id: str):
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    data = {
        "chat_id": chat_id,
        "text": message
    }
    response = requests.post(url, data=data)
    if response.status_code == 200:
        print("âœ… í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ")
    else:
        print(f"âŒ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: {response.status_code}")

# ===== [4] ì‹¤í–‰ í•¨ìˆ˜ =====
def run():
    print(f"ğŸ“… [{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘")
    # ì¥ì• +ì§€ì—­ í‚¤ì›Œë“œ ëª¨ë‘ë¡œ ë‰´ìŠ¤ ìˆ˜ì§‘
    all_keywords = REGIONS + FAULTS
    news = crawl_naver_news(all_keywords)
    # AND ì¡°ê±´ í•„í„°ë§
    filtered_news = filter_news_and(news, REGIONS, FAULTS)
    if filtered_news:
        message = f"ğŸ“° ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ ìš”ì•½ ({len(filtered_news)}ê±´):\n\n" + "\n\n".join(filtered_news)
        send_telegram_message(message, TOKEN, CHAT_ID)
    else:
        print("ğŸ“­ ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")

# ===== [5] ì‹¤í–‰ =====
if __name__ == "__main__":
    run()